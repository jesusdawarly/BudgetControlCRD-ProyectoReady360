<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Presupuestario - Cruz Roja Dominicana</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #ffffff;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #dc143c 0%, #b71c1c 100%);
            padding: 2rem;
            text-align: center;
            box-shadow: 0 4px 20px rgba(220, 20, 60, 0.3);
            border-bottom: 3px solid #fff;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 0.5rem;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2rem;
            background: rgba(220, 20, 60, 0.1);
            border-bottom: 1px solid rgba(220, 20, 60, 0.3);
            flex-wrap: wrap;
            gap: 1rem;
        }

        .currency-toggle {
            display: flex;
            background: rgba(220, 20, 60, 0.2);
            border-radius: 25px;
            padding: 0.3rem;
            border: 2px solid #dc143c;
        }

        .currency-btn {
            padding: 0.7rem 1.5rem;
            border: none;
            background: transparent;
            color: #fff;
            cursor: pointer;
            border-radius: 20px;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .currency-btn.active {
            background: linear-gradient(135deg, #dc143c, #b71c1c);
            box-shadow: 0 2px 10px rgba(220, 20, 60, 0.4);
        }

        .export-buttons {
            display: flex;
            gap: 1rem;
        }

        .export-btn {
            padding: 0.8rem 1.5rem;
            border: 2px solid #dc143c;
            background: linear-gradient(135deg, #dc143c, #b71c1c);
            color: white;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .export-btn:hover {
            background: linear-gradient(135deg, #b71c1c, #8d1414);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(220, 20, 60, 0.4);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .budget-grid {
            display: grid;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .budget-category {
            background: linear-gradient(135deg, rgba(45, 45, 45, 0.9), rgba(30, 30, 30, 0.9));
            border-radius: 15px;
            padding: 1.5rem;
            border: 1px solid rgba(220, 20, 60, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .budget-category:hover {
            transform: translateY(-5px);
            border-color: #dc143c;
            box-shadow: 0 12px 40px rgba(220, 20, 60, 0.2);
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid rgba(220, 20, 60, 0.3);
        }

        .category-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: #dc143c;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .category-total {
            font-size: 1.2rem;
            font-weight: 600;
            color: #fff;
            background: linear-gradient(135deg, #dc143c, #b71c1c);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            box-shadow: 0 2px 10px rgba(220, 20, 60, 0.3);
        }

        .budget-items {
            display: grid;
            gap: 1rem;
        }

        .budget-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 1rem;
            border-left: 4px solid #dc143c;
            transition: all 0.3s ease;
        }

        .budget-item:hover {
            background: rgba(220, 20, 60, 0.1);
            transform: translateX(5px);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.8rem;
        }

        .item-code {
            font-weight: 700;
            color: #dc143c;
            font-size: 0.9rem;
            background: rgba(220, 20, 60, 0.1);
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            border: 1px solid rgba(220, 20, 60, 0.3);
        }

        .item-amount {
            font-weight: 600;
            font-size: 1.1rem;
            color: #4ade80;
        }

        .item-description {
            color: #e5e5e5;
            font-size: 0.95rem;
            line-height: 1.4;
            margin-bottom: 0.8rem;
        }

        .item-progress {
            margin-bottom: 1rem;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #dc143c, #b71c1c);
            transition: all 0.3s ease;
            border-radius: 10px;
        }

        .progress-text {
            font-size: 0.8rem;
            color: #ccc;
            margin-top: 0.3rem;
            text-align: right;
        }

        .expense-form {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .expense-input {
            flex: 1;
            min-width: 120px;
            padding: 0.6rem;
            border: 2px solid rgba(220, 20, 60, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 0.9rem;
        }

        .expense-input:focus {
            outline: none;
            border-color: #dc143c;
            box-shadow: 0 0 10px rgba(220, 20, 60, 0.3);
        }

        .add-expense-btn {
            padding: 0.6rem 1rem;
            border: none;
            background: linear-gradient(135deg, #dc143c, #b71c1c);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .add-expense-btn:hover {
            background: linear-gradient(135deg, #b71c1c, #8d1414);
            transform: translateY(-1px);
        }

        .expenses-list {
            margin-top: 1rem;
            max-height: 200px;
            overflow-y: auto;
        }

        .expense-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 0.8rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            border-left: 3px solid #dc143c;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .expense-details {
            flex: 1;
        }

        .expense-description {
            font-weight: 600;
            color: #fff;
            margin-bottom: 0.2rem;
        }

        .expense-date {
            font-size: 0.8rem;
            color: #aaa;
        }

        .expense-amount {
            font-weight: 700;
            color: #ef4444;
            margin-right: 1rem;
        }

        .delete-expense-btn {
            background: #ef4444;
            border: none;
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .delete-expense-btn:hover {
            background: #dc2626;
            transform: scale(1.05);
        }

        .signature {
            text-align: center;
            margin-top: 3rem;
            padding: 2rem;
            background: linear-gradient(135deg, rgba(220, 20, 60, 0.1), rgba(183, 28, 28, 0.1));
            border-radius: 15px;
            border: 1px solid rgba(220, 20, 60, 0.3);
        }

        .signature-text {
            font-size: 1.1rem;
            font-weight: 600;
            color: #dc143c;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(220, 20, 60, 0.1), rgba(183, 28, 28, 0.1));
            padding: 1.5rem;
            border-radius: 15px;
            border: 2px solid rgba(220, 20, 60, 0.3);
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            border-color: #dc143c;
            box-shadow: 0 8px 25px rgba(220, 20, 60, 0.2);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #4ade80;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #ccc;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .export-buttons {
                justify-content: center;
            }

            .expense-form {
                flex-direction: column;
            }

            .expense-input {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>SISTEMA DE GESTIÓN PRESUPUESTARIA</h1>
        <h3>PROYECTO READY 360° - CRUZ ROJA DOMINICANA</h3>
        <p>JESUS D. RAMIREZ - ADMINISTRADOR DEL PROYECTO</p>
    </div>

    <div class="controls">
        <div class="currency-toggle">
            <button class="currency-btn active" onclick="setCurrency('EUR')">EUR (€)</button>
            <button class="currency-btn" onclick="setCurrency('DOP')">DOP (RD$)</button>
        </div>
        <div class="export-buttons">
            <button class="export-btn" onclick="exportToExcel()">📊 Exportar Excel</button>
            <button class="export-btn" onclick="exportToPDF()">📄 Exportar PDF</button>
        </div>
    </div>

    <div class="container">
        <div class="summary-stats" id="summaryStats">
            <!-- Stats will be populated here -->
        </div>

        <div class="budget-grid" id="budgetGrid">
            <!-- Budget items will be populated here -->
        </div>

        <div class="signature">
            <p class="signature-text">Software Presupuestario hecho por Jesús D. Ramírez (Administrador)</p>
        </div>
    </div>

    <script>
        // Exchange rate EUR to DOP (approximate)
        const EXCHANGE_RATE = 59.50;
        let currentCurrency = 'EUR';
        let expenses = JSON.parse(localStorage.getItem('budgetExpenses')) || {};

        // Complete budget data structure
        const budgetData = {
            "Recursos Humanos": {
                total: 44000,
                items: [
                    {
                        code: "HR.SUP",
                        description: "Personal Logístico/Administrativo - Supervisor de recursos humanos para apoyo logístico y administrativo del proyecto",
                        amount: 20000,
                        details: "1 RH × 20 meses × €1,000"
                    },
                    {
                        code: "HR.PM",
                        description: "Coordinador del Proyecto - Gestión y coordinación general del proyecto de educación en riesgos",
                        amount: 24000,
                        details: "1 RH × 24 meses × €1,000"
                    }
                ]
            },
            "Otros Costos": {
                total: 9112,
                items: [
                    {
                        code: "APUISN.FUNC",
                        description: "Costos de Funcionamiento - Gastos operacionales generales del proyecto",
                        amount: 7200,
                        details: "1 Lump sum × 18 meses × €400"
                    },
                    {
                        code: "APUISN.EQUIP",
                        description: "Compra de Equipos - Adquisición de equipamiento necesario para el proyecto",
                        amount: 1660,
                        details: "1 Lump sum × 2 × €830"
                    },
                    {
                        code: "SNFORM.VIATIC",
                        description: "Capacitación NS - Viáticos para formación FRC/AFD en gestión delegada",
                        amount: 152,
                        details: "1 Log/admin × 4 días × €38"
                    },
                    {
                        code: "SNFORM.TRANSP",
                        description: "Transporte Capacitación - Requerimientos de taxi para capacitación",
                        amount: 100,
                        details: "1 Log/admin × 2 viajes × €50"
                    }
                ]
            },
            "R0 - Comunicación y Obligaciones": {
                total: 300,
                items: [
                    {
                        code: "SNR0A0.CARGO",
                        description: "Sobrepeso y Transporte - Cargo por sobrepeso y transporte de herramientas de comunicación",
                        amount: 200,
                        details: "1 Lump sum × 1"
                    },
                    {
                        code: "SNR0.MOVIL",
                        description: "Gastos de Movilización - Transporte en taxi para actividades del proyecto",
                        amount: 100,
                        details: "1 Lump sum × 1"
                    }
                ]
            },
            "R3.A11 - Marco de Asociación": {
                total: 37009,
                items: [
                    {
                        code: "R50IND.LINEA",
                        description: "Línea Base e Indicadores - Desarrollo de línea base y evaluación final del proyecto",
                        amount: 30000,
                        details: "1 Package × 1 territorio"
                    },
                    {
                        code: "SNR5A1.VISIB",
                        description: "Visibilidad del Proyecto - Elementos de comunicación y promoción del proyecto",
                        amount: 2000,
                        details: "1 territorio × 1 package"
                    },
                    {
                        code: "SNR5A1.PROD",
                        description: "Producción de Visibilidad - Creación de materiales de comunicación",
                        amount: 2000,
                        details: "1 territorio × 1 package"
                    },
                    {
                        code: "SNR5A1.COFFEE1",
                        description: "Coffee Break COPIL/COTECH - Refrigerios para reuniones de comités",
                        amount: 500,
                        details: "1 Lump sum"
                    },
                    {
                        code: "SNR5A1.PRINT1",
                        description: "Impresiones COPIL/COTECH - Material impreso para comités",
                        amount: 60,
                        details: "1 Lump sum"
                    },
                    {
                        code: "SNR5A1.GOOD1",
                        description: "Goodies COPIL/COTECH - Obsequios promocionales para comités",
                        amount: 374,
                        details: "1 Lump sum"
                    },
                    {
                        code: "SNR5A1.COFFEE2",
                        description: "Coffee Break Lanzamiento - Refrigerios para reuniones de lanzamiento de comités",
                        amount: 75,
                        details: "5 comités × 1 lump sum"
                    }
                ]
            },
            "R3.A12 - Kits Educativos": {
                total: 91640,
                items: [
                    {
                        code: "SNR5A2.VISUAL",
                        description: "Identidad Visual del Proyecto - Creación del universo visual y identidad del proyecto",
                        amount: 8000,
                        details: "1 Lump sum"
                    },
                    {
                        code: "SNR5A2.TEST",
                        description: "Test de Visibilidad - Pruebas de elementos de comunicación del proyecto",
                        amount: 8000,
                        details: "1 Lump sum"
                    },
                    {
                        code: "SNR5A2.MATERIAL",
                        description: "Material Didáctico - Preparación de material didáctico y currículos (gráficos incluidos)",
                        amount: 12000,
                        details: "1 Lump sum"
                    },
                    {
                        code: "SNR5A2.COMITES",
                        description: "Movilización Comités - Convocatoria de comités técnicos y pedagógicos",
                        amount: 240,
                        details: "4 comités × 4 veces × €15"
                    },
                    {
                        code: "SNR5A2.PROTO",
                        description: "Impresión Prototipos - Impresión de prototipos de herramientas educativas",
                        amount: 1500,
                        details: "1 Lump sum"
                    },
                    {
                        code: "SNR5A2.SNACK",
                        description: "Refrigerios Niños - Meriendas para niños durante pruebas",
                        amount: 60,
                        details: "1 Lump sum × 4 días × €15"
                    },
                    {
                        code: "SNR5A2.PERDIEM1",
                        description: "Viáticos Voluntarios Test - Compensación para voluntarios durante pruebas",
                        amount: 600,
                        details: "4 días × 15 voluntarios × €10"
                    },
                    {
                        code: "SNR5A2.PERDIEM2",
                        description: "Viáticos Chef Proyecto - Compensación para jefe de proyecto durante pruebas",
                        amount: 80,
                        details: "4 días × 1 persona × €20"
                    },
                    {
                        code: "SNR5A2.FOOD",
                        description: "Alimentación Capacitación - Comida para capacitación de voluntarios",
                        amount: 425,
                        details: "1 Lump sum × 17 personas × €25"
                    },
                    {
                        code: "SNR5A2.PERDIEM3",
                        description: "Viáticos Capacitación - Compensación para voluntarios en capacitación",
                        amount: 150,
                        details: "1 Lump sum × 15 voluntarios × €10"
                    },
                    {
                        code: "SNR5A2.NOTEBOOK",
                        description: "Material Educativo - Cuadernos y bolígrafos para voluntarios",
                        amount: 225,
                        details: "1 Lump sum × 15 voluntarios × €15"
                    },
                    {
                        code: "SNR5A2.VISIB2",
                        description: "Visibilidad Voluntarios - Elementos de identificación para voluntarios",
                        amount: 330,
                        details: "1 Lump sum × 15 voluntarios × €22"
                    },
                    {
                        code: "SNR5A2.COFFEE3",
                        description: "Coffee Break Presentación - Refrigerios para presentación a comités de gestión",
                        amount: 30,
                        details: "1 Lump sum × 2 personas × €15"
                    },
                    {
                        code: "SNR5A2.PRODUCE",
                        description: "Producción Final - Impresión y producción final de materiales educativos",
                        amount: 19000,
                        details: "1 Lump sum"
                    }
                ]
            },
            "R3.A13 - Capacitación Docente": {
                total: 12650,
                items: [
                    {
                        code: "SNR5A3.COFFEE1",
                        description: "Coffee Break Directores - Presentación del proyecto a directores de escuelas",
                        amount: 300,
                        details: "1 Lump sum × 20 personas × €15"
                    },
                    {
                        code: "SNR5A3.CONSUL",
                        description: "Construcción de Contenido - Consultoría para construcción de contenidos educativos",
                        amount: 8000,
                        details: "1 Lump sum"
                    },
                    {
                        code: "SNR5A3.RENTAL",
                        description: "Alquiler de Salas - Renta de espacios para capacitación con coffee incluido",
                        amount: 1500,
                        details: "1 formación × 1 package"
                    },
                    {
                        code: "SNR5A3.FOOD",
                        description: "Alimentación Capacitación - Comida para participantes en formación",
                        amount: 840,
                        details: "1 formación × 42 personas × €20"
                    },
                    {
                        code: "SNR5A3.PRINT",
                        description: "Impresión Documentos - Material impreso para capacitación",
                        amount: 10,
                        details: "1 formación × 1 package × €10"
                    },
                    {
                        code: "SNR5A3.GOODIES",
                        description: "Goodies Capacitación - Obsequios para participantes en formación",
                        amount: 500,
                        details: "1 formación × 1 package × €500"
                    },
                    {
                        code: "SNR5A3.PERDIEM",
                        description: "Viáticos Capacitación - Compensación para participantes",
                        amount: 200,
                        details: "1 Lump sum × 20 personas × €10"
                    },
                    {
                        code: "SNR5A3.DISTRIB",
                        description: "Distribución Kits - Gastos de viaje para distribución de kits educativos",
                        amount: 100,
                        details: "Gastos de referencia - viaje"
                    },
                    {
                        code: "SNR5A3.MONITOR",
                        description: "Monitoreo Escuelas - Seguimiento y apoyo en escuelas identificadas",
                        amount: 600,
                        details: "1 Lump sum × 10 días × €60"
                    },
                    {
                        code: "SNR5A3.COFFEE2",
                        description: "Coffee Break Monitoreo - Reuniones de seguimiento con maestros",
                        amount: 300,
                        details: "3 reuniones × 13 maestros × €15"
                    },
                    {
                        code: "SNR5A3.COFFEE3",
                        description: "Coffee Break Final - Reuniones de fin de año con maestros",
                        amount: 300,
                        details: "3 reuniones × 13 maestros × €15"
                    }
                ]
            },
            "R3.A14 - Capitalización": {
                total: 14876,
                items: [
                    {
                        code: "SNR5A4.PERDIEM1",
                        description: "Viáticos Taller DRR - Compensación para taller de reducción de riesgos en escuela",
                        amount: 152,
                        details: "1 parte × 4 packages × €38"
                    },
                    {
                        code: "SNR5A4.TAXI1",
                        description: "Transporte Taller - Requerimientos de taxi para taller DRR",
                        amount: 100,
                        details: "1 parte × 2 viajes × €50"
                    },
                    {
                        code: "SNR5A4.COFFEE1",
                        description: "Coffee Break Balance - Reunión de balance con comité",
                        amount: 180,
                        details: "1 comité × 12 personas × €15"
                    },
                    {
                        code: "SNR5A4.COFFEE2",
                        description: "Coffee Break Escuela - Balance a nivel escolar con maestros y dirección",
                        amount: 900,
                        details: "3 reuniones × 20 personas × €15"
                    },
                    {
                        code: "SNR5A4.COFFEE3",
                        description: "Coffee Break Cierre - Ceremonia de cierre del proyecto",
                        amount: 500,
                        details: "1 Lump sum"
                    },
                    {
                        code: "SNR5A4.PRINT",
                        description: "Impresiones Cierre - Material impreso para ceremonia de cierre",
                        amount: 60,
                        details: "1 Lump sum"
                    },
                    {
                        code: "SNR5A4.GOODIES",
                        description: "Goodies Cierre - Obsequios para ceremonia de cierre",
                        amount: 500,
                        details: "1 Lump sum"
                    },
                    {
                        code: "SNR5A4.INFOG",
                        description: "Infografía Resultados - Comunicación de resultados de actividades del proyecto",
                        amount: 1500,
                        details: "1 Lump sum"
                    },
                    {
                        code: "SNR5A4.VIDEO",
                        description: "Video Testimonial - Película con testimonios de estudiantes",
                        amount: 10000,
                        details: "1 Lump sum"
                    },
                    {
                        code: "SNR5A4.PERDIEM2",
                        description: "Viáticos Taller Final - Compensación para taller de fin de proyecto",
                        amount: 684,
                        details: "3 personas × 6 días × €38"
                    },
                    {
                        code: "SNR5A4.TAXI2",
                        description: "Transporte Taller Final - Requerimientos de taxi para taller final",
                        amount: 300,
                        details: "3 personas × 2 packages × €50"
                    }
                ]
            }
        };

        function formatCurrency(amount) {
            if (currentCurrency === 'EUR') {
                return `€${amount.toLocaleString('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            } else {
                return `RD${(amount * EXCHANGE_RATE).toLocaleString('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            }
        }

        function setCurrency(currency) {
            currentCurrency = currency;
            document.querySelectorAll('.currency-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderBudget();
        }

        function calculateSpentAmount(itemKey) {
            const itemExpenses = expenses[itemKey] || [];
            return itemExpenses.reduce((total, expense) => total + expense.amount, 0);
        }

        function calculateProgress(budgetAmount, spentAmount) {
            return Math.min((spentAmount / budgetAmount) * 100, 100);
        }

        function addExpense(itemKey, budgetAmount) {
            const descriptionInput = document.getElementById(`desc-${itemKey}`);
            const amountInput = document.getElementById(`amount-${itemKey}`);
            
            const description = descriptionInput.value.trim();
            const amount = parseFloat(amountInput.value);

            if (!description || !amount || amount <= 0) {
                alert('Por favor, complete todos los campos correctamente.');
                return;
            }

            const currentSpent = calculateSpentAmount(itemKey);
            if (currentSpent + amount > budgetAmount) {
                if (!confirm(`⚠️ ALERTA: Este gasto (${formatCurrency(amount)}) excederá el presupuesto asignado.\n\nPresupuesto: ${formatCurrency(budgetAmount)}\nGastado: ${formatCurrency(currentSpent)}\nDisponible: ${formatCurrency(budgetAmount - currentSpent)}\n\n¿Desea continuar?`)) {
                    return;
                }
            }

            if (!expenses[itemKey]) {
                expenses[itemKey] = [];
            }

            expenses[itemKey].push({
                description: description,
                amount: amount,
                date: new Date().toLocaleDateString('es-ES'),
                timestamp: Date.now()
            });

            localStorage.setItem('budgetExpenses', JSON.stringify(expenses));
            
            descriptionInput.value = '';
            amountInput.value = '';
            
            renderBudget();
        }

        function deleteExpense(itemKey, expenseIndex) {
            if (confirm('¿Está seguro de que desea eliminar este registro de gasto?')) {
                expenses[itemKey].splice(expenseIndex, 1);

                if (expenses[itemKey].length === 0) {
                    delete expenses[itemKey];
                }

                localStorage.setItem('budgetExpenses', JSON.stringify(expenses));
                renderBudget();
            }
        }

        function renderBudget() {
            const budgetGrid = document.getElementById('budgetGrid');
            const summaryStats = document.getElementById('summaryStats');
            
            let totalBudget = 0;
            let totalSpent = 0;
            let totalRemaining = 0;

            budgetGrid.innerHTML = '';
            
            Object.keys(budgetData).forEach(categoryName => {
                const category = budgetData[categoryName];
                let categorySpent = 0;
                
                category.items.forEach(item => {
                    const itemKey = item.code;
                    const spent = calculateSpentAmount(itemKey);
                    categorySpent += spent;
                    totalSpent += spent;
                });
                
                totalBudget += category.total;
                totalRemaining += (category.total - categorySpent);

                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'budget-category';
                
                let itemsHtml = '';
                category.items.forEach(item => {
                    const itemKey = item.code;
                    const spentAmount = calculateSpentAmount(itemKey);
                    const remainingAmount = item.amount - spentAmount;
                    const progress = calculateProgress(item.amount, spentAmount);
                    const itemExpenses = expenses[itemKey] || [];

                    let expensesHtml = '';
                    itemExpenses.forEach((expense, index) => {
                        expensesHtml += `
                            <div class="expense-item">
                                <div class="expense-details">
                                    <div class="expense-description">${expense.description}</div>
                                    <div class="expense-date">${expense.date}</div>
                                </div>
                                <div class="expense-amount">-${formatCurrency(expense.amount)}</div>
                                <button class="delete-expense-btn" onclick="deleteExpense('${itemKey}', ${index})">🗑️</button>
                            </div>
                        `;
                    });

                    itemsHtml += `
                        <div class="budget-item">
                            <div class="item-header">
                                <span class="item-code">${item.code}</span>
                                <span class="item-amount">${formatCurrency(item.amount)}</span>
                            </div>
                            <div class="item-description">${item.description}</div>
                            <div class="item-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${progress}%"></div>
                                </div>
                                <div class="progress-text">
                                    Gastado: ${formatCurrency(spentAmount)} | Disponible: ${formatCurrency(remainingAmount)} | ${progress.toFixed(1)}%
                                </div>
                            </div>
                            <div class="expense-form">
                                <input type="text" class="expense-input" id="desc-${itemKey}" placeholder="Descripción del gasto...">
                                <input type="number" class="expense-input" id="amount-${itemKey}" placeholder="Monto" step="0.01" min="0">
                                <button class="add-expense-btn" onclick="addExpense('${itemKey}', ${item.amount})">💰 Registrar</button>
                            </div>
                            ${expensesHtml ? `<div class="expenses-list">${expensesHtml}</div>` : ''}
                        </div>
                    `;
                });

                categoryDiv.innerHTML = `
                    <div class="category-header">
                        <div class="category-title">${categoryName}</div>
                        <div class="category-total">${formatCurrency(category.total)}</div>
                    </div>
                    <div class="budget-items">
                        ${itemsHtml}
                    </div>
                `;

                budgetGrid.appendChild(categoryDiv);
            });

            // Update summary statistics
            const executionRate = totalBudget > 0 ? (totalSpent / totalBudget) * 100 : 0;
            
            summaryStats.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${formatCurrency(totalBudget)}</div>
                    <div class="stat-label">Presupuesto Total</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${formatCurrency(totalSpent)}</div>
                    <div class="stat-label">Total Ejecutado</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${formatCurrency(totalRemaining)}</div>
                    <div class="stat-label">Saldo Disponible</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${executionRate.toFixed(1)}%</div>
                    <div class="stat-label">Tasa de Ejecución</div>
                </div>
            `;
        }

        function exportToExcel() {
            const workbook = XLSX.utils.book_new();
            
            // Create summary sheet
            const summaryData = [
                ['SISTEMA DE GESTIÓN PRESUPUESTARIA - CRUZ ROJA DOMINICANA'],
                ['Generado el:', new Date().toLocaleDateString('es-ES')],
                ['Moneda:', currentCurrency],
                [''],
                ['RESUMEN EJECUTIVO'],
                ['Concepto', 'Monto'],
            ];

            let totalBudget = 0;
            let totalSpent = 0;

            Object.keys(budgetData).forEach(categoryName => {
                const category = budgetData[categoryName];
                let categorySpent = 0;
                
                category.items.forEach(item => {
                    const spent = calculateSpentAmount(item.code);
                    categorySpent += spent;
                });
                
                totalBudget += category.total;
                totalSpent += categorySpent;
            });

            summaryData.push(
                ['Presupuesto Total', formatCurrency(totalBudget)],
                ['Total Ejecutado', formatCurrency(totalSpent)],
                ['Saldo Disponible', formatCurrency(totalBudget - totalSpent)],
                ['Tasa de Ejecución', `${((totalSpent / totalBudget) * 100).toFixed(2)}%`]
            );

            const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(workbook, summarySheet, 'Resumen');

            // Create detailed sheet
            const detailData = [
                ['Código', 'Descripción', 'Presupuesto', 'Gastado', 'Disponible', 'Progreso %']
            ];

            Object.keys(budgetData).forEach(categoryName => {
                detailData.push([categoryName.toUpperCase(), '', '', '', '', '']);
                
                budgetData[categoryName].items.forEach(item => {
                    const spent = calculateSpentAmount(item.code);
                    const remaining = item.amount - spent;
                    const progress = calculateProgress(item.amount, spent);
                    
                    detailData.push([
                        item.code,
                        item.description,
                        item.amount,
                        spent,
                        remaining,
                        `${progress.toFixed(1)}%`
                    ]);
                });
                detailData.push(['', '', '', '', '', '']); // Empty row between categories
            });

            const detailSheet = XLSX.utils.aoa_to_sheet(detailData);
            XLSX.utils.book_append_sheet(workbook, detailSheet, 'Detalle Presupuestario');

            // Create expenses sheet
            const expensesData = [
                ['Código', 'Descripción Gasto', 'Monto', 'Fecha']
            ];

            Object.keys(expenses).forEach(itemKey => {
                expenses[itemKey].forEach(expense => {
                    expensesData.push([
                        itemKey,
                        expense.description,
                        expense.amount,
                        expense.date
                    ]);
                });
            });

            const expensesSheet = XLSX.utils.aoa_to_sheet(expensesData);
            XLSX.utils.book_append_sheet(workbook, expensesSheet, 'Registro de Gastos');

            XLSX.writeFile(workbook, `Presupuesto_CruzRoja_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Header
            doc.setFontSize(18);
            doc.setTextColor(220, 20, 60);
            doc.text('CRUZ ROJA DOMINICANA', 105, 20, { align: 'center' });
            
            doc.setFontSize(14);
            doc.setTextColor(0, 0, 0);
            doc.text('Sistema de Gestión Presupuestaria', 105, 30, { align: 'center' });
            
            doc.setFontSize(10);
            doc.text(`Generado el: ${new Date().toLocaleDateString('es-ES')}`, 20, 45);
            doc.text(`Moneda: ${currentCurrency}`, 20, 52);

            let yPosition = 65;
            
            // Summary statistics
            let totalBudget = 0;
            let totalSpent = 0;

            Object.keys(budgetData).forEach(categoryName => {
                const category = budgetData[categoryName];
                let categorySpent = 0;
                
                category.items.forEach(item => {
                    const spent = calculateSpentAmount(item.code);
                    categorySpent += spent;
                });
                
                totalBudget += category.total;
                totalSpent += categorySpent;
            });

            doc.setFontSize(12);
            doc.setTextColor(220, 20, 60);
            doc.text('RESUMEN EJECUTIVO', 20, yPosition);
            yPosition += 10;

            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            doc.text(`Presupuesto Total: ${formatCurrency(totalBudget)}`, 20, yPosition);
            yPosition += 7;
            doc.text(`Total Ejecutado: ${formatCurrency(totalSpent)}`, 20, yPosition);
            yPosition += 7;
            doc.text(`Saldo Disponible: ${formatCurrency(totalBudget - totalSpent)}`, 20, yPosition);
            yPosition += 7;
            doc.text(`Tasa de Ejecución: ${((totalSpent / totalBudget) * 100).toFixed(2)}%`, 20, yPosition);
            yPosition += 15;

            // Categories summary
            Object.keys(budgetData).forEach(categoryName => {
                if (yPosition > 250) {
                    doc.addPage();
                    yPosition = 20;
                }

                const category = budgetData[categoryName];
                let categorySpent = 0;
                
                category.items.forEach(item => {
                    const spent = calculateSpentAmount(item.code);
                    categorySpent += spent;
                });

                doc.setFontSize(11);
                doc.setTextColor(220, 20, 60);
                doc.text(categoryName.toUpperCase(), 20, yPosition);
                yPosition += 8;

                doc.setFontSize(9);
                doc.setTextColor(0, 0, 0);
                doc.text(`Presupuesto: ${formatCurrency(category.total)} | Ejecutado: ${formatCurrency(categorySpent)}`, 25, yPosition);
                yPosition += 12;
            });

            // Footer
            doc.setFontSize(8);
            doc.setTextColor(128, 128, 128);
            doc.text('POWERED BY DGPC · DAWARLY GESTIÓN PRESUPUESTARIA CONSULTING', 105, 285, { align: 'center' });

            doc.save(`Presupuesto_CruzRoja_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            renderBudget();
        });

        // Add keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'e') {
                e.preventDefault();
                exportToExcel();
            }
            if (e.ctrlKey && e.key === 'p') {
                e.preventDefault();
                exportToPDF();
            }
        });
    </script>
</body>
</html>
